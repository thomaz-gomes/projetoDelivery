services:
  delivery_db:
    image: postgres:17
    environment:
      POSTGRES_USER: tomgomes
      POSTGRES_PASSWORD: 03t01F007TF
      POSTGRES_DB: tomgomes
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      # bind Postgres to localhost only for safety
      - '127.0.0.1:5432:5432'

  backend:
    build:
      context: ./delivery-saas-backend
    # Optionally load environment variables from a local .env file for development
    # (do NOT commit your real .env to git). Docker Compose will read this file
    # and pass variables to the container. If you prefer other secret managers,
    # keep using platform env config instead.
    env_file:
      - ./delivery-saas-backend/.env
    environment:
      DATABASE_URL: postgres://tomgomes:03t01F007TF@delivery_db:5432/tomgomes
      PRISMA_PROVIDER: postgresql
      # Allow the frontend (production) domain to access the API
      FRONTEND_ORIGINS: https://deliverywl.com.br
      NODE_ENV: production
      PORT: 3000
    depends_on:
      - migrate
    ports:
      # backend listens on 3000 inside the container; map to host 3001 to avoid EasyPanel conflict
      - '127.0.0.1:3001:3000'
    restart: unless-stopped

  frontend:
    build:
      context: ./delivery-saas-frontend
      # Allow build-time override of VITE_API_URL via build-arg in CI / deploy
      args:
        - VITE_API_URL
    # When running the frontend container locally via docker compose you can
    # provide runtime env values by creating a `.env.production` file and
    # referencing it here. The file should NOT be committed with secrets.
    env_file:
      - ./delivery-saas-frontend/.env.production
    depends_on:
      - backend
    ports:
      - '127.0.0.1:5173:80'
    restart: unless-stopped

  migrate:
    build:
      context: ./delivery-saas-backend
    command: node scripts/wait-for-db-and-migrate.js
    environment:
      DATABASE_URL: postgres://tomgomes:03t01F007TF@delivery_db:5432/tomgomes
      PRISMA_PROVIDER: postgresql
    depends_on:
      - delivery_db
    restart: 'no'

volumes:
  db_data:
