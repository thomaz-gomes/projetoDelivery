<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
<title>Delivery Print Agent</title>
<style>
/* ── Reset & Base ─────────────────────────────────────────────────── */
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', sans-serif; background: #12121f; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

/* ── Header ───────────────────────────────────────────────────────── */
header { background: #1a1a2e; padding: 14px 24px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #2a2a4a; flex-shrink: 0; }
header h1 { font-size: 16px; color: #4ecca3; font-weight: 700; }
.badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.badge.connected    { background: #0d4a2a; color: #4ecca3; }
.badge.disconnected { background: #4a1a1a; color: #ff6b6b; }
.badge.connecting   { background: #3a3000; color: #ffcc00; }
header .spacer { flex: 1; }
header .version { font-size: 11px; color: #555; }

/* ── Tabs ─────────────────────────────────────────────────────────── */
nav { background: #1a1a2e; display: flex; gap: 2px; padding: 0 24px; border-bottom: 1px solid #2a2a4a; flex-shrink: 0; }
nav button { padding: 10px 18px; background: transparent; border: none; border-bottom: 2px solid transparent; color: #888; font-size: 13px; cursor: pointer; transition: all .2s; }
nav button.active { color: #4ecca3; border-bottom-color: #4ecca3; }
nav button:hover:not(.active) { color: #ccc; }

/* ── Content ──────────────────────────────────────────────────────── */
main { flex: 1; overflow-y: auto; padding: 24px; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ── Cards ────────────────────────────────────────────────────────── */
.card { background: #1a1a2e; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #2a2a4a; }
.card h2 { font-size: 14px; color: #4ecca3; margin-bottom: 16px; text-transform: uppercase; letter-spacing: .5px; }

/* ── Forms ────────────────────────────────────────────────────────── */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
.form-row.single { grid-template-columns: 1fr; }
.field label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
input, select, textarea {
  width: 100%; padding: 8px 12px;
  background: #0f3460; border: 1px solid #1a4a8a;
  border-radius: 6px; color: #fff; font-size: 13px; outline: none;
  transition: border-color .2s;
}
input:focus, select:focus { border-color: #4ecca3; }
select option { background: #0f3460; }
textarea { resize: vertical; min-height: 120px; font-family: 'Consolas', monospace; font-size: 12px; }

/* ── Buttons ─────────────────────────────────────────────────────── */
.btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; font-weight: 600; transition: opacity .2s; }
.btn:hover { opacity: .85; }
.btn:disabled { opacity: .4; cursor: not-allowed; }
.btn-primary { background: #4ecca3; color: #12121f; }
.btn-danger  { background: #c0392b; color: #fff; }
.btn-ghost   { background: #2a2a4a; color: #ccc; }
.btn-sm      { padding: 5px 12px; font-size: 12px; }
.btn-row     { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

/* ── Printer List ─────────────────────────────────────────────────── */
.printer-list { display: flex; flex-direction: column; gap: 10px; }
.printer-item {
  background: #0f3460; border-radius: 8px; padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  border: 1px solid #1a4a8a;
}
.printer-item .pi-name { font-weight: 600; font-size: 14px; }
.printer-item .pi-meta { font-size: 12px; color: #888; margin-top: 2px; }
.printer-item .pi-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 4px; }
.pi-badge.net  { background:#0d3a5a; color:#4ab8ff; }
.pi-badge.usb  { background:#3a0d5a; color:#cc88ff; }
.pi-badge.ser  { background:#3a2a00; color:#ffcc44; }
.pi-badge.on   { background:#0d4a2a; color:#4ecca3; }
.pi-badge.off  { background:#3a1a1a; color:#ff8888; }
.pi-actions { margin-left: auto; display: flex; gap: 6px; }
.printer-empty { text-align: center; color: #555; padding: 32px; font-size: 14px; }

/* ── Modal ────────────────────────────────────────────────────────── */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 100; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: #1a1a2e; border-radius: 12px; padding: 28px; width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto; border: 1px solid #2a2a4a; }
.modal h3 { font-size: 16px; color: #4ecca3; margin-bottom: 20px; }
.modal .close { float: right; background: transparent; border: none; color: #888; font-size: 20px; cursor: pointer; line-height: 1; }
.modal .close:hover { color: #fff; }

/* ── Status / Log ─────────────────────────────────────────────────── */
.stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.stat-box { background: #0f3460; border-radius: 8px; padding: 16px; text-align: center; }
.stat-box .sb-val { font-size: 28px; font-weight: 700; color: #4ecca3; }
.stat-box .sb-lbl { font-size: 12px; color: #888; margin-top: 4px; }

/* ── Toggle ───────────────────────────────────────────────────────── */
.toggle-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.toggle-row label { font-size: 13px; color: #ccc; }
input[type=checkbox].toggle { width: 36px; height: 20px; cursor: pointer; accent-color: #4ecca3; }

/* ── Notification ─────────────────────────────────────────────────── */
#notification { position: fixed; bottom: 20px; right: 20px; padding: 12px 18px; border-radius: 8px; font-size: 13px; display: none; z-index: 999; }
#notification.ok  { background:#0d4a2a; color:#4ecca3; display:block; }
#notification.err { background:#4a1a1a; color:#ff6b6b; display:block; }
</style>
</head>
<body>

<!-- ── Header ──────────────────────────────────────────────────────────── -->
<header>
  <h1>Delivery Print Agent</h1>
  <span id="statusBadge" class="badge disconnected">Desconectado</span>
  <span class="spacer"></span>
  <span class="version">v2.0</span>
</header>

<!-- ── Tabs ────────────────────────────────────────────────────────────── -->
<nav>
  <button class="active" data-tab="printers">Impressoras</button>
  <button data-tab="server">Servidor</button>
  <button data-tab="status">Status</button>
</nav>

<!-- ── Main ────────────────────────────────────────────────────────────── -->
<main>

  <!-- TAB: Impressoras -->
  <div id="tab-printers" class="tab-panel active">
    <div class="card">
      <h2>Impressoras Configuradas</h2>
      <div id="printerList" class="printer-list">
        <div class="printer-empty">Nenhuma impressora configurada.<br>Clique em "Adicionar Impressora".</div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="openPrinterModal()">+ Adicionar Impressora</button>
      </div>
    </div>
  </div>

  <!-- TAB: Servidor -->
  <div id="tab-server" class="tab-panel">
    <div class="card">
      <h2>Conexão com o Servidor</h2>
      <div class="form-row single">
        <div class="field">
          <label>URL do Servidor</label>
          <input id="serverUrl" type="text" placeholder="https://meudelivery.com.br" />
        </div>
      </div>
      <div class="form-row single">
        <div class="field">
          <label>Token do Agente</label>
          <input id="token" type="password" placeholder="Token gerado no Painel → Impressoras" />
        </div>
      </div>
      <div class="toggle-row">
        <input type="checkbox" id="autoStart" class="toggle" />
        <label for="autoStart">Iniciar automaticamente com o Windows</label>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveServer()">Salvar Configurações</button>
      </div>
    </div>
  </div>

  <!-- TAB: Status -->
  <div id="tab-status" class="tab-panel">
    <div class="card">
      <h2>Status do Agente</h2>
      <div class="stat-grid">
        <div class="stat-box">
          <div class="sb-val" id="statConnected">—</div>
          <div class="sb-lbl">Conexão</div>
        </div>
        <div class="stat-box">
          <div class="sb-val" id="statQueued">0</div>
          <div class="sb-lbl">Na Fila</div>
        </div>
        <div class="stat-box">
          <div class="sb-val" id="statPrinters">0</div>
          <div class="sb-lbl">Impressoras</div>
        </div>
      </div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-ghost" onclick="refreshStatus()">Atualizar</button>
        <button class="btn btn-ghost" onclick="window.electronAPI.openLogs()">Abrir Log</button>
        <button class="btn btn-danger btn-sm" onclick="resetConfig()" style="margin-left:auto">Resetar / Reconectar</button>
      </div>
    </div>
  </div>

</main>

<!-- ── Modal: Impressora ───────────────────────────────────────────────── -->
<div id="printerModal" class="modal-overlay">
  <div class="modal">
    <button class="close" onclick="closePrinterModal()">&times;</button>
    <h3 id="modalTitle">Nova Impressora</h3>

    <div class="form-row">
      <div class="field">
        <label>Alias (nome interno)</label>
        <input id="pm-alias" placeholder="Ex: Cozinha 1, Bar, Expedição" />
      </div>
      <div class="field">
        <label>Interface</label>
        <select id="pm-interface" onchange="updateInterfaceFields()">
          <option value="network">Rede TCP/IP (recomendado)</option>
          <option value="usb">USB / Windows Spooler</option>
          <option value="serial">Serial (COM)</option>
        </select>
      </div>
    </div>

    <!-- Rede -->
    <div id="fields-network" class="form-row">
      <div class="field">
        <label>IP da Impressora</label>
        <input id="pm-host" placeholder="192.168.1.100" />
      </div>
      <div class="field">
        <label>Porta TCP</label>
        <input id="pm-port" type="number" value="9100" />
      </div>
    </div>

    <!-- USB -->
    <div id="fields-usb" class="form-row single" style="display:none">
      <div class="field">
        <label>Nome da Impressora no Windows</label>
        <select id="pm-winname">
          <option value="">— Selecione —</option>
        </select>
      </div>
    </div>

    <!-- Serial -->
    <div id="fields-serial" class="form-row" style="display:none">
      <div class="field">
        <label>Porta COM</label>
        <input id="pm-com" placeholder="COM3" />
      </div>
      <div class="field">
        <label>Baud Rate</label>
        <select id="pm-baud">
          <option value="9600">9600</option>
          <option value="19200">19200</option>
          <option value="38400">38400</option>
          <option value="115200">115200</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="field">
        <label>Largura do Papel</label>
        <select id="pm-width">
          <option value="80">80mm (48 colunas)</option>
          <option value="58">58mm (32 colunas)</option>
        </select>
      </div>
      <div class="field">
        <label>Codepage</label>
        <select id="pm-charset">
          <option value="PC850">PC850 (PT-BR padrão)</option>
          <option value="PC437">PC437 (USA / Europa)</option>
          <option value="WIN1252">Windows-1252</option>
          <option value="UTF8">UTF-8 (impressoras modernas)</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="field">
        <label>Densidade (0–15)</label>
        <input id="pm-density" type="number" min="0" max="15" value="8" />
      </div>
      <div class="field">
        <label>Margem Esquerda (colunas)</label>
        <input id="pm-margin" type="number" min="0" max="10" value="0" />
      </div>
    </div>

    <div class="form-row">
      <div class="field">
        <label>Vias (cópias)</label>
        <input id="pm-copies" type="number" min="1" max="5" value="1" />
      </div>
      <div class="field">
        <label>Categorias (vírgula)</label>
        <input id="pm-categories" placeholder="all  ou  food,drink" />
      </div>
    </div>

    <div class="form-row single">
      <div class="field">
        <label>Template personalizado (opcional)</label>
        <textarea id="pm-template" placeholder="Deixe em branco para usar o template padrão..."></textarea>
      </div>
    </div>

    <div class="toggle-row">
      <input type="checkbox" id="pm-enabled" class="toggle" checked />
      <label for="pm-enabled">Impressora ativa</label>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="savePrinter()">Salvar</button>
      <button class="btn btn-ghost" id="btnTestModal" onclick="testCurrentPrinter()">Impressão de Teste</button>
      <button class="btn btn-ghost" onclick="closePrinterModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ── Notification ────────────────────────────────────────────────────── -->
<div id="notification"></div>

<script>
const api = window.electronAPI;
let config = { serverUrl: '', token: '', autoStart: true, printers: [] };
let editingPrinterId = null;
let systemPrinters = [];

// ── Init ─────────────────────────────────────────────────────────────────
async function init() {
  config = await api.loadConfig();
  renderPrinterList();
  loadServerForm();
  refreshStatus();

  // Auto-start
  const as = await api.getAutoStart();
  document.getElementById('autoStart').checked = as;

  // Listen for status updates
  api.onStatusChange(updateStatusBadge);
}

// ── Tabs ─────────────────────────────────────────────────────────────────
document.querySelectorAll('nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'status') refreshStatus();
  });
});

// ── Status ────────────────────────────────────────────────────────────────
function updateStatusBadge(s) {
  const el = document.getElementById('statusBadge');
  if (s.connected) {
    el.textContent = 'Conectado';
    el.className = 'badge connected';
  } else if (s.authError) {
    el.textContent = '⚠ Token inválido';
    el.className = 'badge disconnected';
    // Mostra aviso permanente
    showAuthErrorBanner(s.label);
  } else if (s.label && (s.label.includes('Conectando') || s.label.includes('Reconectando'))) {
    el.textContent = s.label.replace('…', '...').split('(')[0].trim();
    el.className = 'badge connecting';
  } else {
    el.textContent = s.label || 'Desconectado';
    el.className = 'badge disconnected';
  }
}

function showAuthErrorBanner(msg) {
  let banner = document.getElementById('authErrorBanner');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'authErrorBanner';
    banner.style.cssText = 'background:#4a1a1a;color:#ff6b6b;padding:10px 24px;font-size:13px;text-align:center;';
    document.querySelector('main').prepend(banner);
  }
  banner.textContent = msg || 'Token inválido — use "Resetar / Reconectar" na aba Status para refazer o pareamento.';
}

async function refreshStatus() {
  const s = await api.getStatus();
  updateStatusBadge(s);
  document.getElementById('statConnected').textContent = s.connected ? '✓' : '✗';
  document.getElementById('statQueued').textContent    = s.queued || 0;
  document.getElementById('statPrinters').textContent  = (config.printers || []).filter(p => p.enabled).length;
}

// ── Server Form ───────────────────────────────────────────────────────────
function loadServerForm() {
  document.getElementById('serverUrl').value = config.serverUrl || '';
  document.getElementById('token').value     = config.token     || '';
}

async function saveServer() {
  const serverUrl = document.getElementById('serverUrl').value.trim().replace(/\/$/, '');
  const token     = document.getElementById('token').value.trim();
  const autoStart = document.getElementById('autoStart').checked;

  config = { ...config, serverUrl, token };
  await api.saveConfig(config);
  await api.setAutoStart(autoStart);
  notify('Configurações salvas!', 'ok');
}

// ── Printer List ──────────────────────────────────────────────────────────
function renderPrinterList() {
  const el = document.getElementById('printerList');
  const printers = config.printers || [];
  if (printers.length === 0) {
    el.innerHTML = '<div class="printer-empty">Nenhuma impressora configurada.<br>Clique em "Adicionar Impressora".</div>';
    return;
  }
  el.innerHTML = printers.map(p => {
    const ifBadge = { network: 'net', usb: 'usb', serial: 'ser' }[p.interface] || 'net';
    const ifLabel = { network: 'TCP/IP', usb: 'USB', serial: 'COM' }[p.interface] || p.interface;
    return `
    <div class="printer-item">
      <div style="flex:1">
        <div class="pi-name">${esc(p.alias || 'Sem nome')}</div>
        <div class="pi-meta">
          <span class="pi-badge ${ifBadge}">${ifLabel}</span>
          <span class="pi-badge ${p.enabled ? 'on' : 'off'}">${p.enabled ? 'Ativa' : 'Inativa'}</span>
          ${esc(p.interface === 'network' ? `${p.host}:${p.port || 9100}` : p.interface === 'usb' ? (p.windowsPrinterName || '') : (p.comPort || ''))}
          &nbsp;|&nbsp;${p.width || 80}mm &nbsp;|&nbsp; Cats: ${(p.categories || []).join(', ')}
        </div>
      </div>
      <div class="pi-actions">
        <button class="btn btn-sm btn-ghost" onclick="testPrinter('${p.id}')">Teste</button>
        <button class="btn btn-sm btn-ghost" onclick="editPrinter('${p.id}')">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="deletePrinter('${p.id}')">Excluir</button>
      </div>
    </div>`;
  }).join('');
}

// ── Printer Modal ─────────────────────────────────────────────────────────
async function openPrinterModal(id) {
  editingPrinterId = id || null;
  document.getElementById('modalTitle').textContent = id ? 'Editar Impressora' : 'Nova Impressora';
  document.getElementById('btnTestModal').style.display = id ? 'inline-flex' : 'none';

  // Preenche o formulário e exibe o modal ANTES de carregar impressoras do sistema
  if (id) {
    const p = (config.printers || []).find(x => x.id === id);
    if (p) fillPrinterForm(p);
  } else {
    resetPrinterForm();
  }
  document.getElementById('printerModal').classList.add('open');
  updateInterfaceFields();

  // Carrega impressoras do Windows em background (PowerShell pode demorar 3-8s)
  const sel = document.getElementById('pm-winname');
  sel.innerHTML = '<option value="">Carregando impressoras...</option>';
  try {
    systemPrinters = await api.listSystemPrinters();
    const savedName = id ? ((config.printers || []).find(x => x.id === id) || {}).windowsPrinterName || '' : '';
    sel.innerHTML = '<option value="">— Selecione —</option>' +
      systemPrinters.map(p => `<option value="${esc(p.name)}" ${p.name === savedName ? 'selected' : ''}>${esc(p.name)} (${esc(p.port)})</option>`).join('');
  } catch (e) {
    sel.innerHTML = '<option value="">Erro ao listar impressoras</option>';
  }
}

function closePrinterModal() {
  document.getElementById('printerModal').classList.remove('open');
  editingPrinterId = null;
}

// Exposição global para onclick inline
window.openPrinterModal = function(id) { openPrinterModal(id || null); };

function resetPrinterForm() {
  document.getElementById('pm-alias').value      = '';
  document.getElementById('pm-interface').value  = 'network';
  document.getElementById('pm-host').value       = '';
  document.getElementById('pm-port').value       = '9100';
  document.getElementById('pm-winname').value    = '';
  document.getElementById('pm-com').value        = '';
  document.getElementById('pm-baud').value       = '9600';
  document.getElementById('pm-width').value      = '80';
  document.getElementById('pm-charset').value    = 'PC850';
  document.getElementById('pm-density').value    = '8';
  document.getElementById('pm-margin').value     = '0';
  document.getElementById('pm-copies').value     = '1';
  document.getElementById('pm-categories').value = 'all';
  document.getElementById('pm-template').value   = '';
  document.getElementById('pm-enabled').checked  = true;
}

function fillPrinterForm(p) {
  document.getElementById('pm-alias').value      = p.alias || '';
  document.getElementById('pm-interface').value  = p.interface || 'network';
  document.getElementById('pm-host').value       = p.host || '';
  document.getElementById('pm-port').value       = p.port || 9100;
  document.getElementById('pm-winname').value    = p.windowsPrinterName || '';
  document.getElementById('pm-com').value        = p.comPort || '';
  document.getElementById('pm-baud').value       = p.baudRate || 9600;
  document.getElementById('pm-width').value      = p.width || 80;
  document.getElementById('pm-charset').value    = p.characterSet || 'PC850';
  document.getElementById('pm-density').value    = p.density ?? 8;
  document.getElementById('pm-margin').value     = p.marginLeft || 0;
  document.getElementById('pm-copies').value     = p.copies || 1;
  document.getElementById('pm-categories').value = (p.categories || ['all']).join(', ');
  document.getElementById('pm-template').value   = p.template || '';
  document.getElementById('pm-enabled').checked  = p.enabled !== false;
}

function updateInterfaceFields() {
  const iface = document.getElementById('pm-interface').value;
  document.getElementById('fields-network').style.display = iface === 'network' ? '' : 'none';
  document.getElementById('fields-usb').style.display     = iface === 'usb'     ? '' : 'none';
  document.getElementById('fields-serial').style.display  = iface === 'serial'  ? '' : 'none';
}

function collectPrinterForm() {
  const iface = document.getElementById('pm-interface').value;
  const categories = document.getElementById('pm-categories').value
    .split(',').map(s => s.trim().toLowerCase()).filter(Boolean);

  return {
    id: editingPrinterId || crypto.randomUUID(),
    alias:               document.getElementById('pm-alias').value.trim(),
    interface:           iface,
    host:                document.getElementById('pm-host').value.trim(),
    port:                parseInt(document.getElementById('pm-port').value) || 9100,
    windowsPrinterName:  document.getElementById('pm-winname').value,
    comPort:             document.getElementById('pm-com').value.trim(),
    baudRate:            parseInt(document.getElementById('pm-baud').value) || 9600,
    width:               parseInt(document.getElementById('pm-width').value) || 80,
    characterSet:        document.getElementById('pm-charset').value,
    density:             parseInt(document.getElementById('pm-density').value) ?? 8,
    marginLeft:          parseInt(document.getElementById('pm-margin').value) || 0,
    copies:              parseInt(document.getElementById('pm-copies').value) || 1,
    categories:          categories.length ? categories : ['all'],
    template:            document.getElementById('pm-template').value.trim() || null,
    enabled:             document.getElementById('pm-enabled').checked,
  };
}

async function savePrinter() {
  const p = collectPrinterForm();
  if (!p.alias) { notify('Informe o alias da impressora.', 'err'); return; }

  config.printers = config.printers || [];
  const idx = config.printers.findIndex(x => x.id === p.id);
  if (idx >= 0) config.printers[idx] = p;
  else config.printers.push(p);

  await api.saveConfig(config);
  renderPrinterList();
  closePrinterModal();
  notify('Impressora salva!', 'ok');
}

async function deletePrinter(id) {
  if (!confirm('Excluir esta impressora?')) return;
  config.printers = (config.printers || []).filter(p => p.id !== id);
  await api.saveConfig(config);
  renderPrinterList();
  notify('Impressora removida.', 'ok');
}

function editPrinter(id) { openPrinterModal(id); }

async function testPrinter(id) {
  const res = await api.testPrint(id);
  notify(res.ok ? 'Teste enviado!' : 'Falha: ' + (res.error || ''), res.ok ? 'ok' : 'err');
}

async function testCurrentPrinter() {
  if (!editingPrinterId) return;
  await savePrinter(); // salva primeiro
  await testPrinter(editingPrinterId);
}

// ── Notification ──────────────────────────────────────────────────────────
let _notifyTimer;
function notify(msg, type) {
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.className = type;
  clearTimeout(_notifyTimer);
  _notifyTimer = setTimeout(() => { el.className = ''; }, 3500);
}

function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── Reset ─────────────────────────────────────────────────────────────────
async function resetConfig() {
  if (!confirm('Isso vai apagar o token de pareamento e abrir o wizard de configuração novamente.\n\nAs impressoras configuradas serão mantidas.\n\nContinuar?')) return;
  await api.resetConfig();
  // A janela principal é fechada pelo main process; o wizard abre automaticamente.
}

// ── Start ─────────────────────────────────────────────────────────────────
init();
</script>
</body>
</html>
